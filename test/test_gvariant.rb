require 'minitest/autorun'
require 'gvariant'

class GVariantTest < Minitest::Test

  def gvariant_compare(typestr, data, exp)
    assert_equal(exp,  GVariant.read(typestr, data))
    assert_equal(data, GVariant.write(typestr, exp).unpack("C*"))
  end

  def test_basic
    assert GVariant.new(nil, nil) != nil
  end

  def test_invalid_type
    assert_raises ArgumentError do GVariant.read('bb', []) end
    assert_raises ArgumentError do GVariant.read('', [])   end
    assert_raises ArgumentError do GVariant.read('Ã¤', [])  end
    assert_raises ArgumentError do GVariant.read('(a', []) end
  end

  def test_boolean
    gvariant_compare('b', [ 0x00 ], false)
    gvariant_compare('b', [ 0x01 ], true)
  end

  def test_numbers
    gvariant_compare('y', [ 0x2a ],   42)

    gvariant_compare('n', [ 0xd6, 0xff ],  -42)
    gvariant_compare('q', [ 0x2a, 0x00 ],   42)

    gvariant_compare('i', [ 0xd6, 0xff, 0xff, 0xff ],  -42)
    gvariant_compare('u', [ 0x2a, 0x00, 0x00, 0x00 ],   42)

    gvariant_compare('x', [ 0xd6, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff ],  -42)
    gvariant_compare('t', [ 0x2a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 ],   42)
  end

  def test_large_integers
    [ 'x', 't' ].each do |t|
      gvariant_compare(t, [ 0x60, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0 ], 96)
      gvariant_compare(t, [ 0x0, 0xc, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0 ],  3072)
      gvariant_compare(t, [ 0x0, 0x80, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0 ], 98304)
      gvariant_compare(t, [ 0x0, 0x0, 0x30, 0x0, 0x0, 0x0, 0x0, 0x0 ], 3145728)
      gvariant_compare(t, [ 0x0, 0x0, 0x0, 0x6, 0x0, 0x0, 0x0, 0x0 ],  100663296)
      gvariant_compare(t, [ 0x0, 0x0, 0x0, 0xc0, 0x0, 0x0, 0x0, 0x0 ], 3221225472)
      gvariant_compare(t, [ 0x0, 0x0, 0x0, 0x0, 0x18, 0x0, 0x0, 0x0 ], 103079215104)
      gvariant_compare(t, [ 0x0, 0x0, 0x0, 0x0, 0x0, 0x3, 0x0, 0x0 ],  3298534883328)
      gvariant_compare(t, [ 0x0, 0x0, 0x0, 0x0, 0x0, 0x60, 0x0, 0x0 ], 105553116266496)
      gvariant_compare(t, [ 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xc, 0x0 ],  3377699720527872)
    end

    gvariant_compare('x', [ 0xa0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff ], -96)
    gvariant_compare('x', [ 0x0, 0xf4, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff ],  -3072)
    gvariant_compare('x', [ 0x0, 0x80, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff ],  -98304)
    gvariant_compare('x', [ 0x0, 0x0, 0xd0, 0xff, 0xff, 0xff, 0xff, 0xff ],   -3145728)
    gvariant_compare('x', [ 0x0, 0x0, 0x0, 0xfa, 0xff, 0xff, 0xff, 0xff ],    -100663296)
    gvariant_compare('x', [ 0x0, 0x0, 0x0, 0x40, 0xff, 0xff, 0xff, 0xff ],    -3221225472)
    gvariant_compare('x', [ 0x0, 0x0, 0x0, 0x0, 0xe8, 0xff, 0xff, 0xff ],     -103079215104)
    gvariant_compare('x', [ 0x0, 0x0, 0x0, 0x0, 0x0, 0xfd, 0xff, 0xff ],      -3298534883328)
    gvariant_compare('x', [ 0x0, 0x0, 0x0, 0x0, 0x0, 0xa0, 0xff, 0xff ],      -105553116266496)
    gvariant_compare('x', [ 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xf4, 0xff ],       -3377699720527872)
  end

  def test_doubles
    gvariant_compare('d', [ 0x0, 0x0, 0x0, 0x0, 0x0, 0x40, 0x45, 0x40 ], 42.5)
  end

  def test_strings
    gvariant_compare('s', [ 0x00 ], '')
    gvariant_compare('s', [ 0x61, 0x62, 0x63, 0x0 ], 'abc')
  end

  def test_variants
    gvariant_compare('v', [ 0x2a, 0x0, 0x0, 0x0, 0x0, 0x69 ], { type: 'i',  value: 42 })
    gvariant_compare('v', [ 0x2a, 0x0, 0x61, 0x79 ],          { type: 'ay', value: [42] })
  end

  def test_maybes
    gvariant_compare('my', [], nil)
    gvariant_compare('my', [ 0x2a ], 42)
    gvariant_compare('ms', [ 0x61, 0x62, 0x63, 0x0, 0x0 ], 'abc')
  end

  def test_arrays
    gvariant_compare('ay', [], [])
    gvariant_compare('ay', [ 0x1, 0x2, 0x3 ], [ 1, 2, 3 ])
    gvariant_compare('as', [], [])
    gvariant_compare('as', [ 0x61, 0x62, 0x63, 0x0, 0x78, 0x0, 0x79, 0x7a, 0x0, 0x4, 0x6, 0x9 ], [ 'abc', 'x', 'yz' ])
  end

  def test_tuples
    gvariant_compare('()', [], [])
    gvariant_compare('(bus)', [ 0x1, 0x0, 0x0, 0x0, 0x2a, 0x0, 0x0, 0x0, 0x61, 0x62, 0x63, 0x0 ], [ true, 42, 'abc' ])
    gvariant_compare('(bsy)', [ 0x1, 0x61, 0x62, 0x63, 0x0, 0x2a, 0x5 ], [ true, 'abc', 42 ])
  end

  def test_dicts
    gvariant_compare('a{sv}', [], {})
    gvariant_compare('a{sv}', [ 0x61, 0x62, 0x63, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2a, 0x0, 0x0, 0x0, 0x0, 0x69, 0x4, 0x0,
                                0x64, 0x65, 0x66, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2b, 0x0, 0x0, 0x0, 0x0, 0x69, 0x4, 0xf, 0x1f ],
                              [{ abc: { type: 'i', value: 42 }}, { def: { type: 'i', value: 43 }}])
  end

  def test_malformed_read
    assert_equal(false, GVariant.read('b', [ 0x1, 0x1, 0x1 ]))
    assert_equal(0,     GVariant.read('y', []))
    assert_equal(0,     GVariant.read('u', [ 0x00, 0x01 ]))
    assert_equal(0,     GVariant.read('x', [ 0x0, 0x1, 0x2, 0x3 ]))

    assert_equal(true,  GVariant.read('b', [ 0x2a ]))
    assert_equal('',    GVariant.read('s', [ 0x61 ]))
    assert_equal('a',   GVariant.read('s', [ 0x61, 0x0, 0x61, 0x0  ]))

    assert_equal(nil,   GVariant.read('my', []))
    assert_equal(nil,   GVariant.read('mu', [ 0x1, 0x2, 0x3, 0x4, 0x5]))
    assert_equal([],    GVariant.read('aq', [ 0x1 ]))
  end

  def test_spec
    gvariant_compare('aq', [ 0x00, 0x00, 0x1, 0x00, 0x2, 0x00, 0x3, 0x00 ], [ 0, 1, 2, 3 ])
    gvariant_compare('as', [ 104, 101, 108, 108, 111, 0, 119, 111, 114, 108, 100, 0, 0x06, 0x0c ], [ "hello", "world" ])

    # Examples from chapter 2.6 of the specification
    gvariant_compare('s',  [ 104, 101, 108, 108, 111, 32, 119, 111, 114, 108, 100, 0 ], 'hello world')
    gvariant_compare('ms', [ 104, 101, 108, 108, 111, 32, 119, 111, 114, 108, 100, 0, 0 ], 'hello world')
    gvariant_compare('ab', [ 1, 0, 0, 1, 1 ], [ true, false, false, true, true ])
    gvariant_compare('(si)', [ 102, 111, 111, 0, 0xff, 0xff, 0xff, 0xff, 0x04 ], [ 'foo', -1 ])
    gvariant_compare('a(si)',
                     [ 104, 105, 0, 0, 0xfe, 0xff, 0xff, 0xff, 3, 0, 0, 0, 98, 121, 101, 0, 0xff, 0xff, 0xff, 0xff, 4, 9, 0x15 ],
                     [ [ 'hi', -2 ], [ 'bye', -1 ] ])
    gvariant_compare('as',
                     [ 105, 0, 99, 97, 110, 0, 104, 97, 115, 0, 115, 116, 114, 105, 110, 103, 115, 63, 0, 0x02, 0x06, 0x0a, 0x13 ],
                     [ 'i', 'can', 'has', 'strings?' ])

    gvariant_compare('((ys)as)',
                     [ 105, 99, 97, 110, 0, 104, 97, 115, 0, 115, 116, 114, 105, 110, 103, 115, 63, 0, 0x04, 0x0d, 0x05 ],
                     [ [105, 'can'], ['has', 'strings?'] ])

    gvariant_compare('(yy)', [ 0x70, 0x80 ], [ 0x70, 0x80 ])
    gvariant_compare('(iy)', [ 0x60, 0, 0, 0, 0x70, 0, 0, 0 ], [ 96, 0x70 ])
    gvariant_compare('a(iy)', [ 0x60, 0, 0, 0, 0x70, 0, 0, 0, 0x88, 0x02, 0x00, 0x00, 0xf7, 0, 0, 0 ], [[ 96, 0x70 ], [ 648, 0xf7 ]])
    gvariant_compare('ay', [ 0x04, 0x05, 0x06, 0x07 ], [ 0x04, 0x05, 0x06, 0x07 ])
    gvariant_compare('ai', [ 0x04, 0x00, 0x00, 0x00, 0x02, 0x01, 0x00, 0x00 ], [ 4, 258 ])
    gvariant_compare('{si}', [ 97, 32, 107, 101, 121, 0, 0x00, 0x00, 0x02, 0x02, 0x00, 0x00, 0x06 ], { 'a key': 514 })
  end

end